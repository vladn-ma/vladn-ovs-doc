<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>ovs all: How to Install Open vSwitch on Citrix XenServer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ovs all
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__home_vladn_git_ovs_INSTALL_8XenServer.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">How to Install Open vSwitch on Citrix XenServer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document describes how to build and install Open vSwitch on a Citrix XenServer host. If you want to install Open vSwitch on a generic Linux or BSD host, see <a class="el" href="INSTALL_8md.html">INSTALL.md</a> instead.</p>
<p>Open vSwitch should work with XenServer 5.6.100 and later. However, Open vSwitch requires Python 2.7 or later, so using Open vSwitch with XenServer 6.5 or earlier requires installing Python 2.7.</p>
<h2>Building Open vSwitch for XenServer </h2>
<p>You may build from an Open vSwitch distribution tarball or from an Open vSwitch Git tree. The recommended build environment to build RPMs for Citrix XenServer is the DDK VM available from Citrix.</p>
<ol type="1">
<li>If you are building from an Open vSwitch Git tree, then you will need to first create a distribution tarball by running <code>./boot.sh; ./configure; make dist</code> in the Git tree. You cannot run this in the DDK VM, because it lacks tools that are necessary to bootstrap the Open vSwitch distribution. Instead, you must run this on a machine that has the tools listed in <a class="el" href="INSTALL_8md.html">INSTALL.md</a> as prerequisites for building from a Git tree.</li>
<li>Copy the distribution tarball into /usr/src/redhat/SOURCES inside the DDK VM.</li>
<li>In the DDK VM, unpack the distribution tarball into a temporary directory and "cd" into the root of the distribution tarball.</li>
<li><p class="startli">To build Open vSwitch userspace, run: </p><pre class="fragment">`rpmbuild -bb xenserver/openvswitch-xen.spec`
</pre><p class="startli">This produces three RPMs in /usr/src/redhat/RPMS/i386: "openvswitch", "openvswitch-modules-xen", and "openvswitch-debuginfo".</p>
<p class="startli">The above command automatically runs the Open vSwitch unit tests. To disable the unit tests, run: </p><pre class="fragment">`rpmbuild -bb --without check xenserver/openvswitch-xen.spec`
</pre></li>
</ol>
<h2>Build Parameters </h2>
<p>openvswitch-xen.spec needs to know a number of pieces of information about the XenServer kernel. Usually, it can figure these out for itself, but if it does not do it correctly then you can specify them yourself as parameters to the build. Thus, the final "rpmbuild" step above can be elaborated as:</p>
<p>``` VERSION=&lt;Open vswitch="" version&gt;=""&gt; KERNEL_NAME=&lt;Xen kernel="" name&gt;=""&gt; KERNEL_VERSION=&lt;Xen kernel="" version&gt;=""&gt; KERNEL_FLAVOR=&lt;Xen Kernel flavor(suffix) &gt; rpmbuild \ -D "openvswitch_version $VERSION" \ -D "kernel_name $KERNEL_NAME" \ -D "kernel_version $KERNEL_VERSION" \ -D "kernel_flavor $KERNEL_FLAVOR" \ -bb xenserver/openvswitch-xen.spec ```</p>
<p>where: </p><pre class="fragment">`&lt;openvswitch version&gt;` is the version number that appears in the
name of the Open vSwitch tarball, e.g. 0.90.0.

`&lt;Xen Kernel name&gt;` is the name of the XenServer kernel package,
e.g. kernel-xen or kernel-NAME-xen, without the "kernel-" prefix.

`&lt;Xen Kernel version&gt;` is the output of:
rpm -q --queryformat "%{Version}-%{Release}" &lt;kernel-devel-package&gt;,
e.g. 2.6.32.12-0.7.1.xs5.6.100.323.170596, where &lt;kernel-devel-package&gt; is
the name of the -devel package corresponding to &lt;Xen Kernel name&gt;.

`&lt;Xen Kernel flavor (suffix) &gt;` is either "xen" or "kdump".
The "xen" flavor is the main running kernel flavor and the "kdump" flavor is
the crashdump kernel flavor. Commonly, one would specify "xen" here.
</pre><p>For XenServer 6.5 or above, the kernel version naming no longer contains KERNEL_FLAVOR. In fact, only providing the <code>uname -r</code> output is enough. So, the final "rpmbuild" step changes to:</p>
<p>``<code> KERNEL_UNAME=&lt;</code>uname -r` output&gt; rpmbuild \ -D "kenel_uname $KERNEL_UNAME" \ -bb xenserver/openvswitch-xen.spec ```</p>
<h2>Installing Open vSwitch for XenServer </h2>
<p>To install Open vSwitch on a XenServer host, or to upgrade to a newer version, copy the "openvswitch" and "openvswitch-modules-xen" RPMs to that host with "scp", then install them with "rpm -U", e.g.: </p><pre class="fragment"> ```
 scp openvswitch-$VERSION-1.i386.rpm \
     openvswitch-modules-xen-$XEN_KERNEL_VERSION-$VERSION-1.i386.rpm \
     root@&lt;host&gt;:
</pre><p> (At this point you will have to enter &lt;host&gt;'s root password.) ssh root&lt;host&gt; (At this point you will have to enter &lt;host&gt;'s root password again.) rpm -U openvswitch-$VERSION-1.i386.rpm \ openvswitch-modules-xen-$XEN_KERNEL_VERSION-$VERSION-1.i386.rpm ```</p>
<p>To uninstall Open vSwitch from a XenServer host, remove the packages: </p><pre class="fragment"> `ssh root@&lt;host&gt;`
</pre><p> (At this point you will have to enter &lt;host&gt;'s root password again.) <code>rpm -e openvswitch openvswitch-modules-xen-$XEN_KERNEL_VERSION</code></p>
<p>After installing or uninstalling Open vSwitch, the XenServer should be rebooted as soon as possible.</p>
<h2>Open vSwitch Boot Sequence on XenServer </h2>
<p>When Open vSwitch is installed on XenServer, its startup script /etc/init.d/openvswitch runs early in boot. It does roughly the following: </p><pre class="fragment">    * Loads the OVS kernel module, openvswitch.

    * Starts ovsdb-server, the OVS configuration database.

    * XenServer expects there to be no bridges configured at
      startup, but the OVS configuration database likely still has
      bridges configured from before reboot.  To match XenServer
      expectations, the startup script deletes all configured
      bridges from the database.

    * Starts ovs-vswitchd, the OVS switching daemon.
</pre><p>At this point in the boot process, then, there are no Open vSwitch bridges, even though all of the Open vSwitch daemons are running. Later on in boot, /etc/init.d/management-interface (part of XenServer, not Open vSwitch) creates the bridge for the XAPI management interface by invoking /opt/xensource/libexec/interface-reconfigure. Normally this program consults XAPI's database to obtain information about how to configure the bridge, but XAPI is not running yet[*] so it instead consults /var/xapi/network.dbcache, which is a cached copy of the most recent network configuration.</p>
<p>[*] Even if XAPI were running, if this XenServer node is a pool slave then the query would have to consult the master, which requires network access, which begs the question of how to configure the management interface.</p>
<p>XAPI starts later on in the boot process. XAPI can then create other bridges on demand using /opt/xensource/libexec/interface-reconfigure. Now that XAPI is running, that program consults XAPI directly instead of reading the cache.</p>
<p>As part of its own startup, XAPI invokes the Open vSwitch XAPI plugin script /etc/xapi.d/openvswitch-cfg-update passing the "update" command. The plugin script does roughly the following: </p><pre class="fragment">    * Calls /opt/xensource/libexec/interface-reconfigure with the
      "rewrite" command, to ensure that the network cache is
      up-to-date.

    * Queries the Open vSwitch manager setting (named
      "vswitch_controller") from the XAPI database for the
      XenServer pool.

    * If XAPI and OVS are configured for different managers, or if
      OVS is configured for a manager but XAPI is not, runs
      "ovs-vsctl emer-reset" to bring the Open vSwitch
      configuration to a known state.  One effect of emer-reset is
      to deconfigure any manager from the OVS database.

    * If XAPI is configured for a manager, configures the OVS
      manager to match with "ovs-vsctl set-manager".
</pre><h2>Notes </h2>
<ul>
<li>The Open vSwitch boot sequence only configures an OVS configuration database manager. There is no way to directly configure an OpenFlow controller on XenServer and, as a consequence of the step above that deletes all of the bridges at boot time, controller configuration only persists until XenServer reboot. The configuration database manager can, however, configure controllers for bridges. See the BUGS section of ovs-testcontroller(8) for more information on this topic.</li>
<li>The Open vSwitch startup script automatically adds a firewall rule to allow GRE traffic. This rule is needed for the XenServer feature called "Cross-Host Internal Networks" (CHIN) that uses GRE. If a user configures tunnels other than GRE (ex: Geneve, VXLAN, LISP), they will have to either manually add a iptables firewall rule to allow the tunnel traffic or add it through a startup script (Please refer to the "enable-protocol" command in the ovs-ctl(8) manpage).</li>
</ul>
<h2>Reporting Bugs </h2>
<p>Please report problems to <a href="#" onclick="location.href='mai'+'lto:'+'bug'+'s@'+'ope'+'nv'+'swi'+'tc'+'h.o'+'rg'; return false;">bugs@<span style="display: none;">.nosp@m.</span>open<span style="display: none;">.nosp@m.</span>vswit<span style="display: none;">.nosp@m.</span>ch.o<span style="display: none;">.nosp@m.</span>rg</a>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Sep 9 2015 19:08:08 for ovs all by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
